<!DOCTYPE html>
<html>
  <head>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <title>Feedback System</title>
  </head>
  <body>
    <div class="m-5">
      <h1>Feedback System</h1>
      <div class="form-group">
        <label for="exampleInputEmail1">Enter a query</label>
        <input
          type="input"
          class="form-control"
          id="prompt"
          aria-describedby="emailHelp"
          placeholder="Enter a query"
        />
        <small id="emailHelp" class="form-text text-muted"
          >We'll never share your email with anyone else.</small
        >
      </div>
      <button onclick="submitQuestion()" class="mt-1 btn btn-dark">Submit</button>

      <div id="responses"></div>
      <button id="SubmitBulk" class="mt-2 btn btn-dark d-none" onclick="submitBulkFeedback()">
        Submit Bulk Feedback
      </button>
      <button id="clearResponses" class="mt-2 btn btn-danger d-none" onclick="document.getElementById('responses').innerHTML = '';
      document.getElementById('SubmitBulk').classList.add('d-none');
      document.getElementById('clearResponses').classList.add('d-none');
      ">
        Clear Responses
        </button>
    </div>

    <script>
      let recording_id = null;
      async function submitQuestion() {
        event.preventDefault();
        event.stopPropagation();
        const prompt = document.getElementById("prompt").value;

        const response = await fetch("http://localhost:10000/submit/", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: `prompt=${encodeURIComponent(prompt)}`,
        });

        const data = await response.json();
        const responses = data.responses;
        console.log(responses);
        recording_id = data.recording;

        const responsesDiv = document.getElementById("responses");
        responsesDiv.innerHTML = "";

        if (responses.length > 1) {
          document.getElementById("SubmitBulk").classList.remove("d-none");
          document.getElementById("clearResponses").classList.remove("d-none");
        }

        responses.forEach((response, index) => {
          const responseDiv = document.createElement("div");
          responseDiv.innerHTML = `
                <div class="card" style="margin:15px 15px;" id="card-${index}">
                    <div class="card-body">
                        <p><b>Response ${index + 1}</b><p>
                        <b>Act Name:</b> <h5>${response["node.ActId"]}</h5>
                        <b>Section Name:</b> <h5>${
                          response["node.sectionName"]
                        }</h5>
                        <b>Section ID:</b><h5>${response["node.sectionId"]}</h5>
                        <b>Regulation ID:</b><h5>${response["Regulations"]}</h5>
                        <b>url:</b><h5>${response["node.url"]}</h5>
                        <p>${response.text}</p>
                        <input type="radio" name="feedback${index}" value="thumbs_up"> Thumbs Up
                        <input type="radio" name="feedback${index}" value="thumbs_down"> Thumbs Down
                        <button onclick="submitFeedback(${index})" class="btn btn-outline-info">Submit Feedback</button>
                    </div>
                </div>    
            `;
          responsesDiv.appendChild(responseDiv);
        });
      }

      async function submitFeedback(index) {
        const feedback = document.querySelector(
          `input[name="feedback${index}"]:checked`
        ).value;
        if (!recording_id) {
          alert("Please submit a question first");
          return;
        }

        form = new FormData();
        form.append("feedback", feedback);
        form.append("index", index);
        form.append("recording_id", recording_id);

        const response = await fetch("http://localhost:10000/feedback/", {
          method: "POST",
          headers: {
            //"Content-Type": "application/x-www-form-urlencoded",
          },
          body: form,
          /*body: `feedback=${encodeURIComponent(feedback)}index=${index}
                recording_id=${recording_id}
          `,*/
        });

        const data = await response.json();
        console.log(data);
      }

      async function submitBulkFeedback() {
        const responses = document.getElementById("responses").children;
        feedback_value = [];
        for (let i = 0; i < responses.length; i++) {
          feedback = document.querySelector(
            `input[name="feedback${i}"]:checked`
          );
          if (!feedback) {
            alert("Please provide feedback for all responses. Response " + (i + 1) + " is missing feedback.");
            return;
          }
          feedback_value.push(feedback.value);
        }
        form = new FormData();
        form.append("feedback", feedback_value);
        form.append("index", null); // null for bulk feedback
        form.append("recording_id", recording_id);
        form.append("bulk", true);
        const response = await fetch("http://localhost:10000/feedback/", {
          method: "POST",
          headers: {
            //"Content-Type": "application/x-www-form-urlencoded",
          },
          body: form,
        });
        if (response.status == 200 || response.status == 201) {
          const data = await response.json();
          console.log(data);
          if (data.status === true) {  
            alert("Feedback submitted successfully");
            document.getElementById('responses').innerHTML = '';
            document.getElementById('SubmitBulk').classList.add('d-none');
            document.getElementById('clearResponses').classList.add('d-none');
            document.getElementById('prompt').value = '';
            return;
          }
        }
        alert("Error submitting feedback");
      }
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
